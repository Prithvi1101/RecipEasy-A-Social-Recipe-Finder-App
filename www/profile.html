<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Profile - RecipEasy</title>
  <link rel="stylesheet" href="auth-style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: url('bg-img.png') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 2em;
    }
    .profile-container {
      max-width: 700px;
      margin: auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 2em;
      border-radius: 15px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);
    }
    .profile-header {
      text-align: center;
      margin-bottom: 1.5em;
    }
    .profile-header img {
      width: 100px;
      border-radius: 50%;
    }
    .follow-info {
      font-size: 0.9em;
      margin-top: 0.4em;
      color: #444;
    }
    .follow-info span {
      cursor: pointer;
      color: #007bff;
      text-decoration: underline;
      margin: 0 5px;
    }
    .modal {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 1em;
      border-radius: 10px;
      max-width: 300px;
      width: 90%;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      display: none;
      z-index: 10;
    }
    .modal h4 { margin-top: 0; }
    .modal ul { list-style: none; padding: 0; }
    .modal li { padding: 5px 0; border-bottom: 1px solid #eee; }
    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      display: none;
      z-index: 5;
    }
    .post-entry img, .post-entry video {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      object-fit: cover;
    }
    .post-controls button {
      margin-right: 0.5em;
      background-color: #f4c531;
      border: none;
      padding: 0.5em 1em;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
    }
    .post-controls .delete {
      background-color: #dc3545;
      color: white;
    }
  </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="closeModal()"></div>
<div class="modal" id="modal">
  <h4 id="modal-title"></h4>
  <ul id="modal-list"></ul>
</div>

<div class="profile-container">
  <div class="profile-header">
    <img src="default.png" id="profile-photo" alt="Profile Photo" />
    <h2 id="user-name">Loading...</h2>
    <p id="user-email"></p>
    <div class="follow-info" id="follow-info"></div>
  </div>

  <button onclick="goBack()" style="
    display: block;
    margin: 1em auto 2em;
    padding: 0.6em 1.5em;
    font-size: 1em;
    background-color: #f4c531;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  ">‚¨ÖÔ∏è Back</button>

  <h3>üìä Post Analytics</h3>
  <canvas id="likesChart" height="120"></canvas>
  <canvas id="timelineChart" height="120"></canvas>

  <h3>üìú My Recipes</h3>
  <div id="post-list"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
function base64ToBlobUrl(base64) {
  const [meta, content] = base64.split(',');
  const mime = meta.match(/:(.*?);/)[1];
  const byteChars = atob(content);
  const byteArrays = [];
  for (let i = 0; i < byteChars.length; i += 512) {
    const slice = byteChars.slice(i, i + 512);
    const byteNumbers = new Array(slice.length);
    for (let j = 0; j < slice.length; j++) {
      byteNumbers[j] = slice.charCodeAt(j);
    }
    byteArrays.push(new Uint8Array(byteNumbers));
  }
  const blob = new Blob(byteArrays, { type: mime });
  return URL.createObjectURL(blob);
}

const auth = firebase.auth();
auth.onAuthStateChanged(user => {
  if (!user) return location.href = "login.html";
  const data = JSON.parse(localStorage.getItem(`user_${user.uid}`) || '{}');
  document.getElementById("user-name").textContent = data.name || user.email;
  document.getElementById("user-email").textContent = user.email;
  document.getElementById("profile-photo").src = data.photoUrl || "default.png";

  const followers = data.followers || [];
  const following = data.following || [];
  document.getElementById("follow-info").innerHTML = `
    üë• <span onclick="showList('Followers', ${JSON.stringify(followers)})">Followers: ${followers.length}</span>
    | <span onclick="showList('Following', ${JSON.stringify(following)})">Following: ${following.length}</span>
  `;

  const posts = JSON.parse(localStorage.getItem("posts") || "[]").filter(p => p.authorId === user.uid);
  const sharedPosts = JSON.parse(localStorage.getItem("posts") || "[]").filter(p => p.shared === true && p.authorId === user.uid);
  const all = [...posts, ...sharedPosts];

  const postList = document.getElementById("post-list");
  const postTitles = [], postLikes = [], dateCounts = {};

  all.forEach((post, i) => {
    postTitles.push(post.title);
    postLikes.push(post.likes?.length || 0);

    const date = post.timestamp && !isNaN(Date.parse(post.timestamp))
      ? new Date(post.timestamp).toLocaleDateString()
      : "Unknown date";
    dateCounts[date] = (dateCounts[date] || 0) + 1;

    const sharedLine = post.shared ? `<p><strong>üîÅ You shared this post</strong></p>` : "";
    const commentList = post.comments?.map(c =>
      `<div class='comment'><strong>${c.name || c.userId}</strong>: ${c.text}</div>`).join('') || "<p>No comments yet.</p>";

    const mediaSrc = post.mediaUrls?.[0]?.startsWith("data:")
      ? base64ToBlobUrl(post.mediaUrls[0])
      : post.mediaUrls?.[0];

    const div = document.createElement("div");
    div.className = "post-entry";
    div.innerHTML = `
      <h4>${post.title}</h4>
      ${sharedLine}
      <p><strong>Status:</strong> ${post.status}</p>
      <p><strong>Likes:</strong> ${post.likes?.length || 0}</p>
      <p><strong>Posted:</strong> ${date}</p>
      <p>${post.instructions}</p>
      ${post.mediaUrls[0]?.includes("video")
        ? `<video controls src="${mediaSrc}"></video>`
        : `<img src="${mediaSrc}" alt="Post Media" />`}
      <div class="post-controls">
        <button onclick="editPost('${post.timestamp}')">‚úèÔ∏è Edit</button>
        <button class="delete" onclick="deletePost('${post.timestamp}', ${!!post.shared}, '${post.originalId || ''}')">üóëÔ∏è Delete</button>
      </div>
      <div class="comment-box">
        <h4>üí¨ Comments</h4>
        ${commentList}
      </div>
    `;
    postList.appendChild(div);
  });

  new Chart(document.getElementById("likesChart"), {
    type: "bar",
    data: {
      labels: postTitles,
      datasets: [{ label: "Likes", data: postLikes, backgroundColor: "#f4c531" }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });

  new Chart(document.getElementById("timelineChart"), {
    type: "line",
    data: {
      labels: Object.keys(dateCounts),
      datasets: [{ label: "Posts per Day", data: Object.values(dateCounts), borderColor: "#f4c531", fill: false, tension: 0.2 }]
    },
    options: { responsive: true }
  });
});

function editPost(ts) {
  const posts = JSON.parse(localStorage.getItem("posts") || "[]");
  const index = posts.findIndex(p => p.timestamp == ts);
  const post = posts[index];
  const newTitle = prompt("Edit title:", post.title);
  const newInstructions = prompt("Edit instructions:", post.instructions);
  if (newTitle && newInstructions) {
    post.title = newTitle;
    post.instructions = newInstructions;
    posts[index] = post;
    localStorage.setItem("posts", JSON.stringify(posts));
    alert("Post updated.");
    location.reload();
  }
}

function deletePost(ts, isShared, originalId) {
  const posts = JSON.parse(localStorage.getItem("posts") || "[]");
  const index = posts.findIndex(p => p.timestamp == ts);
  if (index === -1) return;
  const user = firebase.auth().currentUser;

  if (isShared && originalId) {
    const originalIndex = posts.findIndex(p => p.timestamp == originalId);
    if (originalIndex !== -1) {
      posts[originalIndex].sharedBy = posts[originalIndex].sharedBy?.filter(uid => uid !== user.uid);
    }
  }
  posts.splice(index, 1);
  localStorage.setItem("posts", JSON.stringify(posts));
  alert("Post deleted.");
  location.reload();
}

function showList(title, uids) {
  const modal = document.getElementById("modal");
  const overlay = document.getElementById("overlay");
  document.getElementById("modal-title").textContent = title;
  const list = document.getElementById("modal-list");
  list.innerHTML = uids.map(uid => {
    const u = JSON.parse(localStorage.getItem(`user_${uid}`) || '{}');
    return `<li>${u.name || uid}</li>`;
  }).join('');
  overlay.style.display = modal.style.display = "block";
}

function closeModal() {
  document.getElementById("overlay").style.display = "none";
  document.getElementById("modal").style.display = "none";
}

function goBack() {
  if (document.referrer) {
    window.history.back();
  } else {
    window.location.href = "dashboard.html";
  }
}
</script>
</body>
</html>

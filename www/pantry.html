<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Pantry - RecipEasy</title>
  <link rel="stylesheet" href="auth-style.css" />

  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Define Capacitor variables (will only be populated in native apps)
    let Capacitor, Filesystem, Directory;

    // Try loading Capacitor if available (safe fallback)
    async function loadCapacitorModules() {
      try {
        const core = await import('@capacitor/core');
        const fs = await import('@capacitor/filesystem');

        Capacitor = core.Capacitor;
        Filesystem = fs.Filesystem;
        Directory = fs.Directory;
      } catch (err) {
        console.warn("Capacitor not available in browser. Falling back to download.");
      }
    }

    // Generate PDF and save to device or download
    window.generateShoppingList = async function () {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFont("Helvetica", "bold");
      doc.setFontSize(18);
      doc.text("Smart Pantry Shopping List", 20, 20);

      doc.setFont("Helvetica", "normal");
      doc.setFontSize(12);

      if (!window.pantry || window.pantry.length === 0) {
        doc.text("No ingredients in pantry.", 20, 40);
      } else {
        window.pantry.forEach((item, index) => {
          const y = 40 + index * 10;
          doc.text(`- ${capitalize(item.name)} (expires: ${item.expiry})`, 20, y);
        });
      }

      const base64pdf = doc.output("datauristring").split(",")[1];

      if (Capacitor?.isNativePlatform?.()) {
        try {
          await Filesystem.writeFile({
            path: "smart_pantry_shopping_list.pdf",
            data: base64pdf,
            directory: Directory.Documents,
          });
          alert("‚úÖ PDF saved to your device!");
        } catch (err) {
          console.error("Error saving with Capacitor:", err);
          alert("‚ùå Failed to save PDF to device.");
        }
      } else {
        doc.save("smart_pantry_shopping_list.pdf");
      }
    };

    loadCapacitorModules(); // Safe async call
  </script>

  <style>
    body {
      background: url('bg-img.png') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Poppins', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }

    .pantry-container {
      background: rgba(255, 255, 255, 0.95);
      padding: 2em;
      border-radius: 15px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }

    h2 {
      text-align: center;
      margin-bottom: 1em;
    }

    input, button {
      width: 100%;
      padding: 0.8em;
      margin-bottom: 1em;
      border-radius: 8px;
      font-size: 1em;
      border: 1px solid #ccc;
      font-family: 'Poppins', sans-serif;
      box-sizing: border-box;
    }

    .submit-btn {
      background: #f4c531;
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    .submit-btn:hover {
      background-color: #d4b420;
    }

    .result-box {
      background: #fff;
      padding: 1em;
      border-radius: 10px;
      font-size: 0.95em;
      color: #333;
      margin-top: 1em;
    }

    ul {
      padding-left: 20px;
    }

    .recipe-card {
      margin-top: 1em;
      border: 1px solid #ccc;
      padding: 1em;
      border-radius: 10px;
      background-color: #fafafa;
    }

    .recipe-card img {
      max-width: 100%;
      border-radius: 8px;
    }

    .back-btn {
      background-color: #ccc;
      color: #333;
      padding: 0.5em 1em;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 1em;
    }

    .recipe-title {
      font-weight: bold;
      font-size: 1.1em;
      margin-top: 0.5em;
    }
  </style>
</head>
<body>
<div class="pantry-container">
  <button class="back-btn" id="back-btn">üîô Back</button>
  <h2>üì¶ Smart Pantry</h2>

  <input id="ingredient-name" type="text" placeholder="Ingredient name" />
  <input id="ingredient-expiry" type="date" />
  <button class="submit-btn" onclick="addToPantry()">Add to Pantry</button>

  <ul id="pantry-list"></ul>

  <button class="submit-btn" onclick="suggestRecipes()">Find Recipes</button>
  <div id="recipe-suggestions" class="result-box"></div>

  <button class="submit-btn" onclick="generateShoppingList()">üõí Generate Shopping List (PDF)</button>
</div>

<script>
  window.pantry = [];

  function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  function addToPantry() {
    const name = document.getElementById("ingredient-name").value.trim().toLowerCase();
    const expiry = document.getElementById("ingredient-expiry").value;
    if (!name || !expiry) return alert("Please fill both fields.");
    pantry.push({ name, expiry });
    document.getElementById("ingredient-name").value = '';
    document.getElementById("ingredient-expiry").value = '';
    updatePantryList();
  }

  function updatePantryList() {
    const ul = document.getElementById("pantry-list");
    ul.innerHTML = pantry.map(item =>
      `<li>${capitalize(item.name)} <em>(expires: ${item.expiry})</em></li>`
    ).join("");
  }

  async function suggestRecipes() {
    const resultDiv = document.getElementById("recipe-suggestions");
    resultDiv.innerHTML = "Loading...";
    const today = new Date();
    const validIngredients = pantry
      .filter(item => new Date(item.expiry) >= today)
      .map(item => item.name);

    if (validIngredients.length === 0) {
      resultDiv.innerHTML = "‚ùå All ingredients are expired!";
      return;
    }

    const recipeIDs = new Set();
    for (const ing of validIngredients) {
      const res = await fetch(`https://www.themealdb.com/api/json/v1/1/filter.php?i=${ing}`);
      const data = await res.json();
      if (data.meals) {
        data.meals.forEach(meal => recipeIDs.add(meal.idMeal));
      }
    }

    if (recipeIDs.size === 0) {
      resultDiv.innerHTML = "‚ùå No matching recipes found.";
      return;
    }

    resultDiv.innerHTML = `<strong>üçΩÔ∏è Recipes you can try:</strong>`;

    for (const id of recipeIDs) {
      const res = await fetch(`https://www.themealdb.com/api/json/v1/1/lookup.php?i=${id}`);
      const data = await res.json();
      if (!data.meals) continue;

      const meal = data.meals[0];
      const html = `
        <div class="recipe-card">
          <img src="${meal.strMealThumb}" alt="${meal.strMeal}">
          <div class="recipe-title">${meal.strMeal}</div>
          <div><strong>Category:</strong> ${meal.strCategory}</div>
          <div><strong>Area:</strong> ${meal.strArea}</div>
          <div><strong>Instructions:</strong> ${meal.strInstructions.slice(0, 300)}...</div>
          <a href="${meal.strYoutube}" target="_blank">‚ñ∂Ô∏è Watch on YouTube</a>
        </div>
      `;
      resultDiv.innerHTML += html;
    }
  }

  // Back button logic (outside suggestRecipes)
  function goBack() {
    if (window.history.length > 1) {
      window.history.back();
    } else {
      window.location.href = "dashboard.html";
    }
  }

  document.getElementById("back-btn").addEventListener("click", goBack);
</script>
</body>
</html>
